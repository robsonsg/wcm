import{f as v}from"./chunk-JMGSQSON.js";import{a as A}from"./chunk-5267M4YT.js";import{Ca as d,Ec as S,I as _,Z as p,aa as y,g as c,ga as g,r as E,s as m}from"./chunk-27GLVKKX.js";var u=class i{module;field;type;constructor(f,e,t){this.module=f,this.field=e,this.type=t}toString(){return`${this.module}.${this.field}[${this.type}]`}static fromString(f){let e=f.match(/^(.+)\.(.+)\[([CRUD])\]$/);if(!e)throw new Error(`Invalid permission format: ${f}`);return new i(e[1],e[2],e[3])}};var U=(()=>{class i{config={secretKey:"wcm-auth-key-2025",algorithm:"AES-256-GCM",keyDerivationRounds:1e4};encrypt(e){return c(this,null,function*(){try{let t=JSON.stringify(e),r=new TextEncoder().encode(t),o=yield this.getKeyMaterial(),a=crypto.getRandomValues(new Uint8Array(16)),n=yield this.deriveKey(o,a),l=crypto.getRandomValues(new Uint8Array(12)),w=yield crypto.subtle.encrypt({name:"AES-GCM",iv:l},n,r),h=new Uint8Array(a.length+l.length+w.byteLength);return h.set(a,0),h.set(l,a.length),h.set(new Uint8Array(w),a.length+l.length),this.arrayBufferToBase64(h.buffer)}catch(t){throw console.error("Erro ao criptografar dados:",t),new Error("Falha na criptografia")}})}decrypt(e){return c(this,null,function*(){try{let t=new Uint8Array(this.base64ToArrayBuffer(e)),s=t.slice(0,16),r=t.slice(16,28),o=t.slice(28),a=yield this.getKeyMaterial(),n=yield this.deriveKey(a,s),l=yield crypto.subtle.decrypt({name:"AES-GCM",iv:r},n,o),h=new TextDecoder().decode(l);return JSON.parse(h)}catch(t){throw console.error("Erro ao descriptografar dados:",t),new Error("Falha na descriptografia")}})}generateHash(e){return c(this,null,function*(){let t=JSON.stringify(e),r=new TextEncoder().encode(t),o=yield crypto.subtle.digest("SHA-256",r);return this.arrayBufferToBase64(o)})}verifyHash(e,t){return c(this,null,function*(){return(yield this.generateHash(e))===t})}getKeyMaterial(){return c(this,null,function*(){let t=new TextEncoder().encode(this.config.secretKey);return yield crypto.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"])})}deriveKey(e,t){return c(this,null,function*(){return yield crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:this.config.keyDerivationRounds,hash:"SHA-256"},e,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])})}arrayBufferToBase64(e){let t=new Uint8Array(e),s="";for(let r=0;r<t.byteLength;r++)s+=String.fromCharCode(t[r]);return btoa(s)}base64ToArrayBuffer(e){let t=atob(e),s=new Uint8Array(t.length);for(let r=0;r<t.length;r++)s[r]=t.charCodeAt(r);return s.buffer}static \u0275fac=function(t){return new(t||i)};static \u0275prov=y({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var N=(()=>{class i{http=g(A);router=g(v);cryptoService=g(U);API_BASE="";STORAGE_KEY="wcm_auth_data";TOKEN_KEY="wcm_access_token";_currentUser=d(null);_userProfiles=d([]);_isAuthenticated=d(!1);_isLoading=d(!1);currentUser=this._currentUser.asReadonly();userProfiles=this._userProfiles.asReadonly();isAuthenticated=this._isAuthenticated.asReadonly();isLoading=this._isLoading.asReadonly();userPermissions=S(()=>{let e=this._userProfiles(),t=[];return e.forEach(s=>{s.permissions.forEach(r=>{r.permissions.forEach(o=>{t.push(new u(r.module,"*",o))}),r.fieldPermissions?.forEach(o=>{o.permissions.forEach(a=>{t.push(new u(r.module,o.field,a))})})})}),t});constructor(){this.loadStoredAuthData()}login(e){return this._isLoading.set(!0),this.http.post(`${this.API_BASE}/api/auth/login`,e).pipe(p(t=>c(this,null,function*(){yield this.handleAuthSuccess(t,e.rememberMe)})),_(t=>(this._isLoading.set(!1),console.error("Erro no login:",t),m(()=>new Error("Falha na autentica\xE7\xE3o")))),p(()=>this._isLoading.set(!1)))}logout(){this.clearAuthData(),this._currentUser.set(null),this._userProfiles.set([]),this._isAuthenticated.set(!1),this.router.navigate(["/loginAuth"])}hasPermission(e,t,s){let r=this.userPermissions();return r.find(n=>n.module===e&&n.field===t&&n.type===s)?!0:!!r.find(n=>n.module===e&&n.field==="*"&&n.type===s)}hasModuleAccess(e){return this.userPermissions().some(s=>s.module===e)}getModulePermissions(e){return this.userPermissions().filter(t=>t.module===e)}refreshToken(){let e=localStorage.getItem("wcm_refresh_token");return e?this.http.post(`${this.API_BASE}/api/auth/refresh`,{refreshToken:e}).pipe(p(t=>{localStorage.setItem(this.TOKEN_KEY,t.accessToken)}),_(t=>(console.error("Erro ao renovar token:",t),this.logout(),m(()=>new Error("Falha ao renovar token"))))):(this.logout(),m(()=>new Error("Token de refresh n\xE3o encontrado")))}loadStoredAuthData(){return c(this,null,function*(){try{let e=localStorage.getItem(this.STORAGE_KEY),t=localStorage.getItem(this.TOKEN_KEY);if(!e||!t)return;let s=JSON.parse(e),r=yield this.cryptoService.decrypt(s.encryptedUser),o=yield this.cryptoService.decrypt(s.encryptedProfiles);if(!(yield this.cryptoService.verifyHash(r,s.hash))){console.warn("Dados de autentica\xE7\xE3o corrompidos"),this.clearAuthData();return}this._currentUser.set(r),this._userProfiles.set(o),this._isAuthenticated.set(!0)}catch(e){console.error("Erro ao carregar dados de autentica\xE7\xE3o:",e),this.clearAuthData()}})}handleAuthSuccess(e,t){return c(this,null,function*(){try{let s=yield this.cryptoService.encrypt(e.user),r=yield this.cryptoService.encrypt(e.profiles),o=yield this.cryptoService.generateHash(e.user),a={encryptedUser:s,encryptedProfiles:r,hash:o};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(a)),localStorage.setItem(this.TOKEN_KEY,e.accessToken),localStorage.setItem("wcm_refresh_token",e.refreshToken),this._currentUser.set(e.user),this._userProfiles.set(e.profiles),this._isAuthenticated.set(!0)}catch(s){throw console.error("Erro ao processar autentica\xE7\xE3o:",s),new Error("Falha ao armazenar dados de autentica\xE7\xE3o")}})}clearAuthData(){localStorage.removeItem(this.STORAGE_KEY),localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem("wcm_refresh_token")}generateSampleAuthResponse(){return E({user:{username:"nurse_maria",fullName:"Maria Silva Santos",profession:"Enfermeira Especialista em Homecare",email:"maria.santos@homecare.com.br",profileIds:["profile_nurse","profile_coordinator"],isActive:!0,lastLogin:new Date},profiles:[{profileId:"profile_nurse",profileName:"Enfermeira de Campo",description:"Perfil para enfermeiras que atendem pacientes em domic\xEDlio",permissions:[{module:"cad_patients",permissions:["R","U"],fieldPermissions:[{field:"patient_name",permissions:["R","U"]},{field:"patient_codigo",permissions:["R"]},{field:"medical_history",permissions:["R","U"]}]},{module:"appointments",permissions:["C","R","U"],fieldPermissions:[{field:"appointment_notes",permissions:["C","R","U"]},{field:"vital_signs",permissions:["C","R","U"]}]},{module:"treatments",permissions:["R","U"],fieldPermissions:[{field:"treatment_status",permissions:["U"]},{field:"medication_log",permissions:["C","R","U"]}]}],isActive:!0,createdAt:new Date("2024-01-15"),updatedAt:new Date("2024-12-01")}],accessToken:"sample_jwt_token_"+Date.now(),refreshToken:"sample_refresh_token_"+Date.now(),expiresIn:3600})}static \u0275fac=function(t){return new(t||i)};static \u0275prov=y({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();export{N as a};
